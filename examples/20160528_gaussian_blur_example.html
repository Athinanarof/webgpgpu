<html>
<script src="colormaps.js"></script>
<script src="webgl_raster.js"></script>

<script id="blur-x" type="x-shader/x-fragment">//<![CDATA[
// This shader will be rendered to the screen
#define OUT gl_FragColor
#define IN  gl_FragCoord.xy
precision mediump float;
uniform sampler2D input_data;
uniform int   width;
uniform float parameters[2*WIDTH+1];
void main() {
    vec4 c = vec4(0,0,0,0);
    for (int i=-WIDTH;i<=WIDTH;i++)
        c += texture2D(input_data, (IN + vec2(i,0))/512.0)
        * parameters[i+width];
    c *= c;
    OUT = c/c.a;
}
//]]></script>

<script id="blur-y" type="x-shader/x-fragment">//<![CDATA[
// This shader will be rendered to the screen
#define OUT gl_FragColor
#define IN  gl_FragCoord.xy
precision mediump float;
uniform sampler2D input_data;
void main() {
    vec4 c = vec4(0,0,0,0);
    for (int i=-WIDTH;i<=WIDTH;i++)
        c += texture2D(input_data, (IN + vec2(0,i))/512.0);
    OUT = c/c.a;
}
//]]></script>

<script id="draw-input" type="x-shader/x-fragment">
// This shader will be rendered to a texture
precision mediump   float;
#define OUT gl_FragColor
#define IN  gl_FragCoord.xy
void main() {
    float cx = mod(floor(IN.x/32.),2.);
    float cy = mod(floor(IN.y/32.),2.);
    float chex = mod(cx+cy,2.);
    OUT = vec4(chex,1-chex,chex,1);
}
</script>

<script>





/**
 * Initialize a program with a specific vertex and fragment shader
 * For our purposes, we only ever render rasters to textures or
 * to screen, so we can take care of some of that boilerplate here.
 */
function getKernelProgram(gl,width,direction) {
    var axis = direction=='y'? 1 : 0;
    var program = getDefaultRasterProgram(gl);
    var kernel_source =
    "#define WIDTH "+width+"\n"+
    "#define AX    "+axis +"\n"+
    "#define SIZE  512.0 \n"+
    `precision mediump float;
     uniform sampler2D indata;
     uniform float weights[2*WIDTH+1];
     void main() {
         vec4 c = vec4(0,0,0,0);
         for (int i=-WIDTH; i<=WIDTH; i++)
             c += texture2D(indata, (gl_FragCoord.xy + vec2(i*(1-AX),i*AX))/SIZE)*weights[i+WIDTH];
         gl_FragColor = c/c.a;
     }`;
    compileAndBindShader(gl,program,kernel_source,gl.FRAGMENT_SHADER);
    gl.linkProgram(program);
    if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
        alert("Could not initialise kernel shader");
        return null;
    }
    // We also need to manually pass arguments to the shader
    // This tells us to forward vertex attributes to the variable
    // called p inside the vertex (geometry) shader
    activateVertexShaderPosition(gl,program);
    return program;
}


// This is the main script that will run when the website loads
function main()
{
    // Prepare kernel
    var sigma   = 3.;
    var width   = Math.ceil(3*sigma);
    var support = width*2+1;
    console.log('Kernel width is ' + support);
    // Just use sampled Gaussian for now for the kernel
    var kernel = new Float32Array(support);
    var centre = Math.ceil(support/2);
    var sum = 0.;
    for (var i=0; i<support; i++)
        sum += kernel[i] = Math.exp(-0.5*Math.pow((i-centre)/sigma,2));
    for (var i=0; i<support; i++)
        kernel[i] /= sum;
    console.log(kernel);

    // Retrieve a handle to the canvas element
    var canvas = $("maincanvas");

    // Try to create a WebGL context on the canvas, abort if it fails
    var gl = getRasterGL(canvas);
    if (!gl) OUT;

    var buffer1 = newBasicFramebuffer(gl,canvas.width,canvas.height);
    var buffer2 = newBasicFramebuffer(gl,canvas.width,canvas.height);

    var render = getRasterProgram(gl,'draw-input');

    var blur_y_kernels = [];
    var blur_y_kernels = [];
    //for (var i=1;i<10;i++) {
    var i=5;
    var blur_x = getKernelProgram(gl,i,'x');
    var blur_y = getKernelProgram(gl,i,'y');
    bindTexture (gl,blur_x,"indata",1,buffer1.texture);
    bindTexture (gl,blur_y,"indata",2,buffer2.texture);
    //}

    gl.useProgram(blur_x);
    var pointer = gl.getUniformLocation(blur_x, 'parameters');
    gl.uniform1fv(pointer, new Float32Array(kernel));
    var pointer = gl.getUniformLocation(blur_x, 'width');
    gl.uniform1i(pointer, support);


    renderProgram(gl,render,buffer1);
    renderProgram(gl,blur_x,buffer2);
    renderProgram(gl,blur_y);
}
</script>
<body onload="javascript:main()">
<canvas id='maincanvas' style="width:512px;height:512px;"></canvas>
</body>
</html>
