<html>
<script src="colormaps.js"></script>
<script src="webgl_raster.js"></script>

<script id="blur" type="x-shader/x-fragment">
// Gaussian blue in X or Y directions
// Variables W, K, AX will be defined later when shader is compiled
#define XY gl_FragCoord.xy
precision mediump   float;
uniform   sampler2D data;
uniform   float     weights[2*K+1];
void main() {
    vec4 c = vec4(0,0,0,0);
    for (int i=-K; i<=K; i++)
        c += texture2D(data, (XY + vec2(i*(1-AX),i*AX))/W) * weights[i+K];
    gl_FragColor = c;
}
</script>

<script id="draw-input" type="x-shader/x-fragment">
precision mediump   float;
#define OUT gl_FragColor
#define IN  gl_FragCoord.xy
void main() {
    float cx = mod(floor(IN.x/32.),2.);
    float cy = mod(floor(IN.y/32.),2.);
    float chex = mod(cx+cy,2.);
    OUT = vec4(chex,chex,chex,1);
}
</script>


<script id="show" type="x-shader/x-fragment">
// copies a texture buffer to screen
precision mediump   float;
uniform   sampler2D data;
void main() {
    gl_FragColor = texture2D(data,gl_FragCoord.xy/W);
}
</script>


<script>

/**
 * Initialize a Guassian convolution kernel
 * @param sigma {float} - positive floating point value for standard deviation
 * @return {Float32Array} - additional fields width and radius are stored too.
 */
function createGaussianKernel(sigma) {
    // Prepare kernel
    var radius = Math.ceil(3*sigma);
    var length = radius*2+1;
    var kernel = new Float32Array(length);
    var sum = 0.;
    for (var i=0; i<length; i++)
        sum += kernel[i] = Math.exp(-0.5*Math.pow((i-radius)/sigma,2));
    for (var i=0; i<length; i++)
        kernel[i] /= sum;
    kernel = new Float32Array(kernel);
    kernel.radius = radius;
    return kernel;
}

// This is the main script that will run when the website loads
function main()
{
    // Retrieve a handle to the canvas element
    var canvas = $("maincanvas");

    // Create a WebGL context on the canvas, abort if fail
    var gl = getRasterGL(canvas);
    if (!gl) OUT;

    var kernel = createGaussianKernel(2);
    console.log(kernel)

    var buffer1 = newBasicFramebuffer(gl,{
        size : canvas.width,
        wrap : gl.REPEAT});
    var buffer2 = newBasicFramebuffer(gl,{
        size : canvas.width,
        wrap : gl.REPEAT});

    var show   = getRasterProgram(gl,'show',{W:'512.'});
    var render = getRasterProgram(gl,'draw-input');
    var blur_x = getRasterProgram(gl,'blur',{W:'512.',K:kernel.radius,AX:0});
    var blur_y = getRasterProgram(gl,'blur',{W:'512.',K:kernel.radius,AX:1});

    render( {}, buffer1 );
    show( {data:buffer1} );

    function animate() {
        setTimeout(function(){
            blur_x( {weights:kernel, data:buffer1}, buffer2 );
            blur_y( {weights:kernel, data:buffer2}, buffer1 );
            show( {data:buffer1} );
            requestAnimationFrame(animate);
        },1000/100.);
    }
    animate();
}
</script>
<body onload="javascript:main()">
<canvas id='maincanvas' style="width:512px;height:512px;"></canvas>
</body>
</html>
